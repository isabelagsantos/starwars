---
output: 
  github_document: 
    toc: true
editor_options: 
  chunk_output_type: inline
---
```{r}
#carregando o pacote/coleção de pacote tidyverse
#install.packages("tidyverse")
library(tidyverse)
#install.packages("skimr")
library(skimr)
```
A seguir, será feito o carregamento dos dados e a análise inicial do comportamento dos deles na base de dados Star Wars:
```{r}
#carregando a base de dados Star Wars
head(starwars)
tail(starwars)

dados <- starwars
```

Com uma visão global, será visualizado se há dados faltantes (NA's) e em quais variáveis
```{r}
#verificando se há valores NA's
skim(dados)
```


```{r}
#verificando em quais variáveis há valores NA's
cat("As variáveis que possuem dados faltantes são:\n")
for(i in names(dados)){
  if(any(is.na(dados[[i]]))){
    cat("•",i,"\n")
  }
}
```

Verifica-se logo que as variáveis acima possuem valores faltantes (Na's). Dessa forma, é necessário tratá-las:
```{r}
#height
head(dados$height)
tail(dados$height)

count(dados[is.na(dados$height),]) #há 6 observações sem a altura (height)
dados[is.na(dados$height),]
dados %>%
  filter(is.na(height)) %>%
  select(name)
```
Após uma conferência no Wookieepedia, enciclopédia criada sobre Star Wars, nota-se que os personagens adiante possuem as respectivas alturas:

Arvel Crynyd: não encontrado (desconhecido/unknown)
Finn: 178
Rey: 170
Poe Dameron: 172
BB8: 67
Captain Phasma: 200

Dessa forma, será imputado tais valores para conhecidos para eliminar os NA's:
```{r}
dados[c(28, 83, 84, 85, 86, 87), c("name","height")]
dados[c(28, 83, 84, 85, 86, 87), "height"] <- c(NA, 178, 170, 172, 67, 200)
dados[c(28, 83, 84, 85, 86, 87), c("name","height")]
```

```{r}
#mass
head(dados$mass)
tail(dados$mass)

count(dados[is.na(dados$mass),])
dados[is.na(dados$mass),]
rownames(dados)[is.na(dados$mass)]
dados %>%
  filter(is.na(mass)) %>%
  select(name)
```
Dessa forma, os seguintes personagens estão sem valores na variável mass:

Wilhuff Tarkin				
Mon Mothma				
Arvel Crynyd				
Finis Valorum				
Rugor Nass				
Ric Olié				
Watto				
Quarsh Panaka				
Shmi Skywalker				
Bib Fortuna

...

Jocasta Nu				
R4-P17				
San Hill				
Finn				
Rey				
Poe Dameron				
BB8				
Captain Phasma

Totalizando 28 personagens sem os dados referentes à variável mass.

Diferentemente da variável height, que possuia 6 dados faltantes, na variável em questão, há 28 observações, o que dificulta a procura de cada personagem e imputação manual. A partir disso, pensei imputar pelo método das tendências centrais, utilizando a mediana, mas diferenciandos por espécies e gênero, quando há.

O ideal seria usar um modelo de regressão para prever os valores, mas, por limitação técnica, não será possível. No entanto, a utilização da mediana não é indevida: tem embasamento e procedência, principalmente com os cuidados em relação aos fatores citados.

Assim, é preciso verificar a espécie e o gênero de cada observação:
```{r}
dados %>% 
  filter(is.na(mass)) %>% 
  select(name, species, gender) %>% 
  arrange(desc(species), group_by = T)
```

Com as espécies disponíveis e o gênero, é necessário encontrar a mediana de suas categorias.
```{r}
species_mass_na <- dados %>% 
  group_by(species) %>% 
  summarise(
    n_personagem = n(),
    n_na_mass = sum(is.na(mass)),
    n_masculine = sum(gender=="masculine", na.rm = TRUE),
    n_feminine = sum(gender=="feminine", na.rm = TRUE),
    n_masculine_na_mass = sum(is.na(mass) & gender=="masculine"),
    n_feminine_na_mass = sum(is.na(mass) & gender=="feminine"),
    prop_na_mass = round((n_na_mass / n_personagem)*100, 2),
    prop_na_masculine = round((n_masculine_na_mass / n_masculine)*100, 2),
    prop_na_feminine = round((n_feminine_na_mass / n_feminine)*100, 2)
  ) %>% 
  filter(n_na_mass>0)

species_mass_na

sum(species_mass_na$n_na_mass)
```
Com essa tabela, é possível observar alguns pontos:
1. há personagens com NA na massa, mas é o único da base de dados (ex.: Mas Amedda);
2. há personagens de determinada espécie e gênero com NA na massa, mas é o único da base de dados (ex.: Yarael Poof e R4-P17);

Assim, é necessário fazer o filtro inicial para eliminar aqueles que do ponto 1 (n_personagem = n_na_mass) e 2 (n_masculine = n_masculine_na_mass e n_feminine = n_feminine_na_mass). Para isso, é preciso retirar aqueles com proporção de personagens com NA na massa igual a 100% (prop_na_mass = 100) e aqueles que a proporção de NA em um gênero específico seja igual a 100% (prop_na_masculine = 100 e prop_na_feminine = 100):
```{r}
imput_na_mass <- species_mass_na %>% 
  filter(prop_na_mass < 100, prop_na_masculine < 100, prop_na_feminine < 100)

imput_na_mass
```
Sendo assim, os únicos que são elegíveis a receber esse tipo de imputação são os da espécie (specie) humana (Human).

Logo, é preciso estudar os humanas que possuem NA na massa em relação ao gênero e as quantidades, tanto de cada gênero em relação ao total quanto de cada gênero em relação aos número de NA na massa.
